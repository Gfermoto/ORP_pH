# 🌊 ESP32 Pool Water Quality Sensor

Прошивка для ESP32 для мониторинга качества воды в бассейне с использованием pH и ORP датчиков. Система обеспечивает:
- 📶 Беспроводную передачу данных через WiFi
- 📊 Аналоговое считывание значений с датчиков
- 🔋 Питание от USB или внешнего источника
- 🔦 Визуальную индикацию работы
- 🔘 Возможность программирования и сброса
- 🏊 Интеграцию с Home Assistant для удобного мониторинга состояния воды

## 📋 О проекте

Этот проект разработан для мониторинга качества воды в бассейне. Система позволяет:
- Контролировать уровень pH для поддержания оптимальной кислотности воды
- Измерять окислительно-восстановительный потенциал (ORP) для контроля эффективности дезинфекции
- Получать уведомления о выходе параметров за допустимые пределы
- Автоматически сохранять историю измерений
- Удаленно контролировать состояние воды через веб-интерфейс

### Компоненты системы:
- [Плата для подключения датчиков pH и ORP](https://aliexpress.ru/item/1005004359552599.html?spm=a2g2w.orderdetail.0.0.77c54aa6Pej2KM&sku_id=12000028897270491)
- [Liquid PH 0-14 Value Detection Regulator Sensor Module](https://aliexpress.ru/item/1005007574685909.html) (аналог [Grove - PH Sensor](https://wiki.seeedstudio.com/Grove-PH_Sensor/))
- [Liquid ORP Value Detection Regulator Sensor Module](https://aliexpress.ru/item/1005007574685909.html) (аналог [Grove - ORP Sensor Kit](https://wiki.seeedstudio.com/Grove-ORP-Sensor-kit/))

## 🎛️ Рекомендуемая плата ESP32

Для проекта рекомендуется использовать плату [ESP32-WROOM-32](https://aliexpress.ru/item/1005005776600877.html) со следующими характеристиками:

- 🎯 Модель: ESP32-WROOM-32
- 💾 Flash память: 4MB
- 📶 WiFi: 802.11 b/g/n
- 📡 Bluetooth: 4.2 BR/EDR и BLE
- 🔋 Напряжение питания: 3.3V
- 🔌 GPIO: 34 программируемых пинов
- ⚡ Ток потребления: ~80mA в активном режиме
- 📏 Размеры: 25.5 x 18 мм

> 💡 Плата ESP32-WROOM-32 является оптимальным выбором для данного проекта благодаря:
> - Стабильной работе с аналоговыми входами
> - Достаточному количеству GPIO пинов
> - Встроенной антенне WiFi
> - Хорошей поддержке в Arduino IDE
> - Доступной цене

## 📊 Характеристики датчиков

### pH Датчик
| Параметр | Диапазон |
|----------|----------|
| 🧪 pH | 0-14 |
| 🌡️ Температурная компенсация | 0-60℃ |
| ⏱️ Время отклика | ≤1s |
| 📏 Точность | ±0.1pH (25℃) |
| 🔋 Напряжение питания | 3.3V |
| 📡 Интерфейс | Аналоговый |
| 🔢 Разрешение АЦП | 12 бит |
| 📊 Формула расчета | E = 59.16 (mV/pH) |

### ORP Датчик
| Параметр | Диапазон |
|----------|----------|
| ⚡ ORP | -2000 до 2000 mV |
| 🌡️ Температурная компенсация | 0-60℃ |
| ⏱️ Время отклика | ≤1s |
| 📏 Точность | ±5mV |
| 🔋 Напряжение питания | 3.3V |
| 📡 Интерфейс | Аналоговый |
| 🔢 Разрешение АЦП | 12 бит |
| 📊 Формула расчета | ORP = ((30 * Vcc * 1000) - (75 * avg * Vcc * 1000/4095))/75 - OFFSET |

## 🔌 Подключение

### ESP32 к модулям датчиков
```
ESP32          Модуль pH датчика
5V    ------>  VCC
GND   ------>  GND
GPIO34 ------> PO (аналоговый выход)

ESP32          Модуль ORP датчика
5V    ------>  VCC
GND   ------>  GND
GPIO35 ------> PO (аналоговый выход)
```

### Подключение датчиков
```
Модуль pH датчика  pH датчик
BNC разъем <--- BNC разъем

Модуль ORP датчика  ORP датчик
BNC разъем <--- BNC разъем
```

## ⚙️ Начальная настройка

1. 🔌 При первом включении датчик создаст точку доступа WiFi:
   - 📶 SSID: `WaterSensor`
   - 🔑 Пароль: `12345678`
   - 🌐 IP адрес: `192.168.4.1`

2. 💻 Подключитесь к точке доступа и откройте веб-браузер по адресу `http://192.168.4.1`

3. ⚙️ В веб-интерфейсе доступны две вкладки:

   ### 📊 Вкладка "Показания"
   - Отображает текущие значения pH и ORP в реальном времени
   - Позволяет настроить калибровочные коэффициенты для каждого датчика:
     - Смещение (offset) - добавляется к измеренному значению
     - Множитель (scale) - умножается на измеренное значение
   - Обновление данных происходит каждые 5 секунд
   - Калибровочные коэффициенты сохраняются в энергонезависимой памяти

   ### ⚙️ Вкладка "Настройка"
   - Позволяет настроить параметры подключения:
     - 📶 WiFi SSID и пароль
     - 📡 Адрес MQTT сервера
     - 🔑 Логин и пароль MQTT (если требуется)
   - После сохранения настроек датчик перезагрузится и подключится к указанной WiFi сети

## 🔄 OTA Обновление

Система поддерживает обновление прошивки по воздуху (OTA). Для обновления:

1. Подключите датчик к WiFi сети
2. В Arduino IDE:
   - Выберите порт: `pool-sensor.local` (или IP адрес датчика)
   - Нажмите "Загрузить" (Upload)
3. Дождитесь завершения обновления

> ⚠️ Важно:
> - Датчик должен быть подключен к той же WiFi сети, что и компьютер
> - Не отключайте питание во время обновления
> - При проблемах с подключением используйте IP адрес вместо имени хоста

## 💻 Настройка в Arduino IDE

1. 📚 Установите необходимые библиотеки:
   - PubSubClient
   - ArduinoJson
   - WiFi
   - WebServer
   - EEPROM

2. ⚡ Загрузите прошивку на ESP32

## 🏠 Интеграция с Home Assistant

Прошивка автоматически создает следующие сенсоры в Home Assistant:

- 🧪 pH Value (значение pH)
- ⚡ ORP Value (значение ORP в mV)

> 💡 Все сенсоры будут автоматически обнаружены в Home Assistant при первом подключении ESP32 к MQTT брокеру.

## 📡 MQTT Топики

- ⚙️ Конфигурация pH сенсора: `homeassistant/sensor/ph_sensor/config`
- ⚙️ Конфигурация ORP сенсора: `homeassistant/sensor/orp_sensor/config`
- 📊 Состояние: `homeassistant/sensor/water_sensor/state`

## 🔧 Технические детали

- 📝 Протокол: MQTT
- ⚡ Скорость передачи: 115200 бод
- 📊 Формат данных: JSON
- ⏱️ Интервал обновления данных: 5 секунд

## 🧪 Калибровка датчиков

### Калибровка pH датчика

Для калибровки pH датчика рекомендуется использовать [набор калибровочных растворов](https://aliexpress.ru/item/1005007173486273.html?spm=a2g2w.orderdetail.0.0.7f8d4aa6BnNwCq&sku_id=12000039699789577), который включает:
- pH 4.01 (красный)
- pH 6.86 (зеленый)
- pH 9.18 (синий)

#### Процедура калибровки:

1. 🔄 Подготовка:
   - Вымойте датчик дистиллированной водой
   - Высушите датчик мягкой салфеткой
   - Подготовьте чистые стаканы для каждого раствора

2. 📊 Калибровка по трем точкам:
   - Погрузите датчик в раствор pH 6.86 (нейтральный)
   - Дождитесь стабилизации показаний (1-2 минуты)
   - В веб-интерфейсе введите значение 6.86
   - Нажмите "Сохранить калибровку"
   
   - Промойте датчик дистиллированной водой
   - Погрузите в раствор pH 4.01 (кислый)
   - Дождитесь стабилизации
   - Введите значение 4.01
   - Нажмите "Сохранить калибровку"
   
   - Промойте датчик дистиллированной водой
   - Погрузите в раствор pH 9.18 (щелочной)
   - Дождитесь стабилизации
   - Введите значение 9.18
   - Нажмите "Сохранить калибровку"

3. ✅ Проверка калибровки:
   - Промойте датчик дистиллированной водой
   - Погрузите в раствор pH 6.86
   - Убедитесь, что показания соответствуют значению раствора
   - Погрузите в раствор pH 4.01
   - Убедитесь, что показания соответствуют значению раствора
   - Погрузите в раствор pH 9.18
   - Убедитесь, что показания соответствуют значению раствора

4. ⚠️ Важные замечания:
   - Используйте только свежие растворы
   - Храните растворы в плотно закрытых бутылках
   - Не смешивайте растворы между собой
   - После калибровки промойте датчик дистиллированной водой
   - Высушите датчик перед хранением
   - Проводите калибровку при комнатной температуре (20-25°C)
   - Избегайте попадания прямых солнечных лучей на растворы

5. 🔄 Периодичность калибровки:
   - При первом использовании датчика
   - После длительного хранения
   - При изменении температуры более чем на 10°C
   - При подозрении на неточность измерений
   - Рекомендуется проводить калибровку не реже 1 раза в месяц

### Калибровка ORP датчика

Для калибровки ORP датчика используется раствор с известным значением 256mV ([калибровочный раствор](https://aliexpress.ru/item/1005005530457843.html?sku_id=12000033431556016&spm=a2g2w.productlist.search_results.0.4a1e68f018nF5z)).

#### Процедура калибровки:

1. 🔄 Подготовка:
   - Вымойте датчик дистиллированной водой
   - Высушите датчик мягкой салфеткой
   - Подготовьте раствор для калибровки

2. 📊 Калибровка:
   - Погрузите датчик в калибровочный раствор
   - Дождитесь стабилизации показаний (1-2 минуты)
   - В веб-интерфейсе введите значение 256
   - Нажмите "Сохранить калибровку"

## ⚠️ Примечания

- 🔧 Датчики требуют калибровки перед первым использованием
- 🔋 Рекомендуется использовать стабилизированный источник питания
- 🌡️ При длительной работе в агрессивной среде рекомендуется периодически проверять точность измерений
- 📡 Для работы MQTT необходим MQTT брокер (например, Mosquitto)
- 🔒 Рекомендуется использовать защищенное соединение MQTT (TLS)
- 🔄 Для сброса настроек к заводским, удерживайте кнопку BOOT при включении питания

## 🔗 Полезные ссылки

- [🛒 Плата для подключения датчиков pH и ORP](https://aliexpress.ru/item/1005004359552599.html?spm=a2g2w.orderdetail.0.0.77c54aa6Pej2KM&sku_id=12000028897270491)
- [🛒 Модуль pH на AliExpress](https://aliexpress.ru/item/1005007574685909.html)
- [🛒 Модуль ORP на AliExpress](https://aliexpress.ru/item/1005007574685909.html)
- [📚 Документация Grove - PH Sensor](https://wiki.seeedstudio.com/Grove-PH_Sensor/)
- [📚 Документация Grove - ORP Sensor Kit](https://wiki.seeedstudio.com/Grove-ORP-Sensor-kit/)
- [🛒 ESP32 на AliExpress](https://aliexpress.ru/item/1005005776600877.html)
- [🧪 Набор калибровочных растворов pH](https://aliexpress.ru/item/1005007173486273.html?spm=a2g2w.orderdetail.0.0.7f8d4aa6BnNwCq&sku_id=12000039699789577)
- [🏠 Документация по MQTT Discovery в Home Assistant](https://www.home-assistant.io/docs/mqtt/discovery/)
- [🛠️ Инструкция по установке и настройке](SETUP.md)
- [📡 Принципиальная схема подключения](SCHEMATIC.md) 
